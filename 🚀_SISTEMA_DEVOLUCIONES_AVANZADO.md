# üöÄ Sistema Avanzado de Devoluciones - Integraci√≥n Inventario

## üìã Visi√≥n General

Actualmente las devoluciones solo registran dinero. Necesitamos un sistema que:

1. **Reintegre productos al inventario** (cuando est√°n en buen estado)
2. **Registre en "Aver√≠as"** (cuando est√°n da√±ados)
3. **Maneje cambios con proveedor** (si el proveedor acepta cambio)
4. **Registre p√©rdidas como egresos** (si no hay cambio con proveedor)

---

## üèóÔ∏è Estructura de Datos Requerida

### 1. Mejora de la Tabla `devoluciones`

```sql
ALTER TABLE devoluciones ADD COLUMN (
  estado_producto VARCHAR(50) DEFAULT 'Buen Estado',  -- 'Buen Estado', 'Da√±ado'
  tiene_cambio_proveedor BOOLEAN DEFAULT FALSE,
  registrado_como_egreso BOOLEAN DEFAULT FALSE,
  id_egreso UUID REFERENCES egreso(id),
  notas_adicionales TEXT
);
```

**Estados del Producto:**
- `Buen Estado` ‚Üí Reintegrar al inventario
- `Da√±ado` ‚Üí Registrar en Aver√≠as (nueva tabla)
- `Cambio Proveedor` ‚Üí Usar si proveedor acepta cambio
- `P√©rdida Total` ‚Üí Registrar como egreso

---

### 2. Nueva Tabla: `averias`

Para rastrear productos da√±ados:

```sql
CREATE TABLE averias (
  id UUID DEFAULT uuid_generate_v4() PRIMARY KEY,
  owner UUID NOT NULL REFERENCES auth.users(id),
  producto_id UUID REFERENCES inventario(id),
  nombre_producto VARCHAR(255) NOT NULL,
  cantidad INT DEFAULT 1,
  causa_dano TEXT,
  id_devolucion UUID REFERENCES devoluciones(id),
  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  estado VARCHAR(50) DEFAULT 'Pendiente',  -- 'Pendiente', 'Canjeada', 'Desechada'
  fecha_resolucion TIMESTAMP,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

---

## üîÑ Flujo Completo de Devoluciones

### Caso 1: Producto en Buen Estado
```
1. Usuario registra devoluci√≥n
2. Selecciona "Buen Estado"
3. Sistema:
   - Busca el producto en inventario
   - Suma la cantidad devuelta a: inventario.cantidad
   - Crea egreso reversible (entrada de dinero al cliente)
   - Marca devoluci√≥n como "Aprobada - Reintegrado"
```

### Caso 2: Producto Da√±ado - CON Cambio de Proveedor
```
1. Usuario registra devoluci√≥n
2. Selecciona "Da√±ado" + marca "Tiene cambio con proveedor"
3. Sistema:
   - Registra en tabla "averias" con estado = "Canjeada"
   - NO crea egreso (se canjea por nuevo producto)
   - Marca devoluci√≥n como "Aprobada - Canjeada con Proveedor"
```

### Caso 3: Producto Da√±ado - SIN Cambio de Proveedor
```
1. Usuario registra devoluci√≥n
2. Selecciona "Da√±ado" + marca "Sin cambio con proveedor"
3. Sistema:
   - Registra en tabla "averias" con estado = "Desechada"
   - Crea EGRESO por el valor del producto
     (representa p√©rdida del negocio)
   - Marca devoluci√≥n como "Aprobada - Egreso Registrado"
   - Guarda referencia del egreso
```

---

## üíª Cambios de C√≥digo Necesarios

### 1. AppContext.jsx - Nueva funci√≥n

```javascript
const registrarDevolucionAvanzada = async (devolucion) => {
  // devolucion contiene:
  // {
  //   codigo_venta: string,
  //   cliente: string,
  //   producto: string,
  //   cantidad: number,
  //   monto: number,
  //   razon: string,
  //   estado_producto: 'Buen Estado' | 'Da√±ado',
  //   tiene_cambio_proveedor: boolean,
  //   notas_adicionales: string
  // }

  try {
    // 1. Buscar producto en inventario
    const productoEnInventario = inventario.find(
      p => p.nombre.toLowerCase() === devolucion.producto.toLowerCase()
    );

    // 2. Si es "Buen Estado" ‚Üí Reintegrar al inventario
    if (devolucion.estado_producto === 'Buen Estado') {
      if (productoEnInventario) {
        await actualizarProducto(productoEnInventario.id, {
          cantidad: productoEnInventario.cantidad + devolucion.cantidad
        });
      }
      // Crear entrada de dinero (egreso negativo)
      await crearEgreso({
        tipo: 'Devoluci√≥n - Reembolso',
        monto: -devolucion.monto,  // Negativo = entrada de dinero
        descripcion: `Reembolso por devoluci√≥n de ${devolucion.producto}`
      });
    }
    
    // 3. Si es "Da√±ado"
    if (devolucion.estado_producto === 'Da√±ado') {
      // Registrar en averias
      const nuevoRegistroAveria = await registrarAveria({
        nombre_producto: devolucion.producto,
        cantidad: devolucion.cantidad,
        causa_dano: devolucion.razon,
        id_devolucion: devolucion.id,
        estado: devolucion.tiene_cambio_proveedor ? 'Canjeada' : 'Desechada'
      });

      // Si NO tiene cambio con proveedor ‚Üí crear egreso (p√©rdida)
      if (!devolucion.tiene_cambio_proveedor) {
        const egresoCreado = await crearEgreso({
          tipo: 'P√©rdida por Da√±o',
          monto: devolucion.monto,  // Egreso normal
          descripcion: `P√©rdida: ${devolucion.producto} da√±ado (${devolucion.cantidad}u.)`
        });

        // Actualizar devoluci√≥n con referencia del egreso
        await actualizarDevoluci√≥n(devolucion.id, {
          registrado_como_egreso: true,
          id_egreso: egresoCreado.id
        });
      }
    }

    // 4. Actualizar estado de devoluci√≥n a "Aprobada"
    await actualizarEstadoDevolucion(devolucion.id, 'Aprobada');

    return { success: true, message: 'Devoluci√≥n procesada correctamente' };
  } catch (error) {
    return { success: false, message: error.message };
  }
};
```

### 2. Devoluciones.jsx - Mejoras en UI

**Agregar en el modal campos nuevos:**

```jsx
{ventaSeleccionada && (
  <>
    {/* ... campos existentes ... */}

    {/* NUEVO: Estado del Producto */}
    <Form.Group className="mb-3">
      <Form.Label>Estado del Producto</Form.Label>
      <Form.Select
        value={formData.estado_producto || 'Buen Estado'}
        onChange={(e) => setFormData({ 
          ...formData, 
          estado_producto: e.target.value,
          tiene_cambio_proveedor: false  // resetear
        })}
      >
        <option value="Buen Estado">‚úÖ Buen Estado - Reintegrar</option>
        <option value="Da√±ado">‚ùå Da√±ado</option>
      </Form.Select>
    </Form.Group>

    {/* NUEVO: Si est√° da√±ado, preguntar por cambio */}
    {formData.estado_producto === 'Da√±ado' && (
      <Form.Group className="mb-3">
        <Form.Check
          type="checkbox"
          label="‚úÖ El proveedor acepta cambio"
          checked={formData.tiene_cambio_proveedor || false}
          onChange={(e) => setFormData({
            ...formData,
            tiene_cambio_proveedor: e.target.checked
          })}
        />
        <small className="text-muted d-block mt-2">
          {formData.tiene_cambio_proveedor
            ? "‚úÖ Se canjear√° con el proveedor (sin egreso)"
            : "‚ö†Ô∏è Se registrar√° como p√©rdida (egreso del negocio)"}
        </small>
      </Form.Group>
    )}

    {/* NUEVO: Notas adicionales */}
    <Form.Group className="mb-3">
      <Form.Label>Notas Adicionales</Form.Label>
      <Form.Control
        as="textarea"
        rows={2}
        placeholder="Detalles adicionales sobre la devoluci√≥n"
        value={formData.notas_adicionales || ''}
        onChange={(e) => setFormData({ 
          ...formData, 
          notas_adicionales: e.target.value 
        })}
      />
    </Form.Group>
  </>
)}
```

### 3. Dashboard.jsx - Agregar resumen de Aver√≠as

```jsx
// En el dashboard, mostrar:
const totalAverias = averias.length;
const averiasPendientes = averias.filter(a => a.estado === 'Pendiente').length;

<Card>
  <Card.Body className="text-center">
    <h6>Productos en Aver√≠as</h6>
    <h4>{totalAverias}</h4>
    <small className="text-warning">{averiasPendientes} pendientes</small>
  </Card.Body>
</Card>
```

---

## üìä Ejemplos de Uso

### Ejemplo 1: Cliente devuelve producto en buen estado
```
Venta: VTA-2024-001 | Cliente: Juan | Producto: Mouse | Monto: $50

Devoluci√≥n registrada:
‚úÖ Producto: Buen Estado
‚úÖ Cantidad: 1

Sistema hace:
1. Actualiza inventario: Mouse +1 unidad
2. Crea egreso de -$50 (reembolso)
3. Estado devoluci√≥n: "Aprobada - Reintegrado"
4. Dashboard muestra ingreso en Egresos
```

### Ejemplo 2: Cliente devuelve producto da√±ado - con cambio
```
Venta: VTA-2024-002 | Cliente: Mar√≠a | Producto: Teclado | Monto: $150

Devoluci√≥n registrada:
‚ùå Producto: Da√±ado
‚úÖ Tiene cambio: S√ç

Sistema hace:
1. Registra en Aver√≠as: "Canjeada"
2. NO crea egreso (se canjea)
3. Estado devoluci√≥n: "Aprobada - Canjeada"
4. Nota para admin: "Enviar a proveedor para canje"
```

### Ejemplo 3: Cliente devuelve producto da√±ado - sin cambio
```
Venta: VTA-2024-003 | Cliente: Pedro | Producto: Monitor | Monto: $800

Devoluci√≥n registrada:
‚ùå Producto: Da√±ado
‚ùå Tiene cambio: NO

Sistema hace:
1. Registra en Aver√≠as: "Desechada"
2. Crea egreso de $800 (p√©rdida del negocio)
3. Estado devoluci√≥n: "Aprobada - Egreso Registrado"
4. Dashboard muestra egreso de $800
5. Nota financiera: "P√©rdida documentada"
```

---

## üéØ Pasos para Implementar

### Fase 1: Base de Datos
1. ‚úÖ Ejecutar SQL para alterar tabla `devoluciones`
2. ‚úÖ Ejecutar SQL para crear tabla `averias`
3. ‚úÖ Crear √≠ndices para performance

### Fase 2: Backend (AppContext.jsx)
1. ‚úÖ Crear `registrarAveria()`
2. ‚úÖ Crear `obtenerAverias()`
3. ‚úÖ Mejorar `registrarDevolucion()` ‚Üí versi√≥n avanzada
4. ‚úÖ Mejorar `actualizarEstadoDevolucion()`

### Fase 3: Frontend
1. ‚úÖ Mejorar UI de `Devoluciones.jsx` con nuevos campos
2. ‚úÖ Crear componente `Averias.jsx` para ver/gestionar aver√≠as
3. ‚úÖ Actualizar `Dashboard.jsx` con resumen de aver√≠as
4. ‚úÖ Agregar al navbar si es necesario

### Fase 4: Testing
1. ‚úÖ Probar devoluci√≥n de producto en buen estado
2. ‚úÖ Probar devoluci√≥n de producto da√±ado con cambio
3. ‚úÖ Probar devoluci√≥n de producto da√±ado sin cambio
4. ‚úÖ Verificar que egresos se registren correctamente
5. ‚úÖ Verificar que inventario se actualice

---

## üîç Beneficios

| Aspecto | Antes | Despu√©s |
|--------|-------|---------|
| **Seguimiento inventario** | ‚ùå Perd√≠a productos | ‚úÖ Reintegraci√≥n autom√°tica |
| **Control de da√±os** | ‚ùå Sin registro | ‚úÖ Tabla de Aver√≠as |
| **Cambios proveedor** | ‚ùå Manual | ‚úÖ Autom√°tico |
| **P√©rdidas financieras** | ‚ö†Ô∏è Parcial | ‚úÖ Egreso documentado |
| **Reportes** | ‚ùå Incompletos | ‚úÖ Detallados |
| **Auditor√≠a** | ‚ùå Dif√≠cil | ‚úÖ Completa |

---

## ‚ùì Preguntas Pendientes

Antes de implementar, confirma:

1. ¬øNecesitas un componente de "Aver√≠as" en el navbar?
2. ¬øLos cambios con proveedor necesitan flujo de aprobaci√≥n?
3. ¬øQuieres reportes mensuales de devoluciones/aver√≠as?
4. ¬øLos egresos de devoluciones deben afectar "Deuda" del mes?

---

## üìû Pr√≥ximos Pasos

**Opci√≥n A:** Implemento todo de una vez (m√°s trabajo, pero completo)
**Opci√≥n B:** Implementamos por fases (m√°s r√°pido, por partes)

¬øCu√°l prefieres? üöÄ