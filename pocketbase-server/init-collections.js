import PocketBase from "pocketbase";

const pb = new PocketBase(process.env.POCKETBASE_URL || "https://mantente-pocketbase.fly.dev");

const collections = [
  {
    name: "users",
    type: "auth",
    fields: [
      { name: "email", type: "email", required: true },
      { name: "username", type: "text", required: true },
      { name: "emailVisibility", type: "bool", defaultValue: false },
      { name: "verified", type: "bool", defaultValue: false },
    ],
  },
  {
    name: "averias",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "producto", type: "text" },
      { name: "cantidad", type: "number" },
      { name: "razon_dano", type: "text" },
      { name: "tiene_cambio_proveedor", type: "bool" },
      { name: "referencia_canje", type: "text" },
      { name: "nombre_proveedor", type: "text" },
      { name: "precio_unitario", type: "number" },
      { name: "estado", type: "text" },
      { name: "fecha", type: "date" },
      { name: "registrada_por", type: "text" },
      { name: "notas", type: "text" },
    ],
  },
  {
    name: "cierre_mes",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "mes_cierre", type: "date" },
      { name: "estado", type: "text" },
      { name: "total_ingresos", type: "number" },
      { name: "total_egresos", type: "number" },
      { name: "total_descuentos", type: "number" },
      { name: "ganancia_neta", type: "number" },
      { name: "cantidad_ventas", type: "number" },
      { name: "cantidad_clientes", type: "number" },
      { name: "notas", type: "text" },
      { name: "fecha_cierre", type: "date" },
      { name: "fecha_creacion", type: "date" },
      { name: "fecha_actualizacion", type: "date" },
    ],
  },
  {
    name: "clientes",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "nombre", type: "text", required: true },
      { name: "email", type: "text" },
      { name: "telefono", type: "text" },
      { name: "direccion", type: "text" },
      { name: "ciudad", type: "text" },
      { name: "departamento", type: "text" },
      { name: "ruc", type: "text" },
      { name: "razon_social", type: "text" },
      { name: "notas", type: "text" },
      { name: "estado", type: "text" },
    ],
  },
  {
    name: "customers",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "code", type: "text" },
      { name: "name", type: "text", required: true },
      { name: "email", type: "text" },
      { name: "phone", type: "text" },
      { name: "address", type: "text" },
      { name: "city", type: "text" },
      { name: "state", type: "text" },
      { name: "zip_code", type: "text" },
      { name: "country", type: "text" },
      { name: "tax_id", type: "text" },
      { name: "contact_person", type: "text" },
      { name: "payment_terms", type: "text" },
      { name: "credit_limit", type: "number" },
      { name: "is_active", type: "bool" },
      { name: "notes", type: "text" },
    ],
  },
  {
    name: "devoluciones",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "venta_id", type: "text" },
      { name: "monto", type: "number" },
      { name: "cantidad", type: "number" },
      { name: "razon", type: "text" },
      { name: "cliente", type: "text" },
      { name: "producto", type: "text" },
      { name: "fecha", type: "date" },
      { name: "estado", type: "text" },
      { name: "tipo_resolucion", type: "text" },
      { name: "estado_producto", type: "text" },
      { name: "producto_nuevo", type: "text" },
      { name: "cantidad_nueva", type: "number" },
      { name: "precio_nuevo", type: "number" },
      { name: "diferencia_precio", type: "number" },
      { name: "tiene_cambio_proveedor", type: "bool" },
      { name: "referencia_canje", type: "text" },
      { name: "id_ingreso", type: "text" },
      { name: "id_egreso", type: "text" },
      { name: "fecha_procesada", type: "date" },
      { name: "procesada_por", type: "text" },
      { name: "notas_adicionales", type: "text" },
      { name: "cantidad_devuelta", type: "number" },
      { name: "codigo_venta", type: "text" },
    ],
  },
  {
    name: "egreso",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "descripcion", type: "text", required: true },
      { name: "monto", type: "number", required: true },
      { name: "categoria", type: "text" },
      { name: "fecha", type: "date" },
      { name: "mes_cierre", type: "date" },
      { name: "notas", type: "text" },
    ],
  },
  {
    name: "empresa_profiles",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "nombre", type: "text" },
      { name: "identificacion_fiscal", type: "text" },
      { name: "email", type: "text" },
      { name: "telefono", type: "text" },
      { name: "direccion", type: "text" },
      { name: "logo_url", type: "text" },
    ],
  },
  {
    name: "facturas",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "numero_factura", type: "text", required: true },
      { name: "cliente", type: "text", required: true },
      { name: "items", type: "json" },
      { name: "subtotal", type: "number" },
      { name: "total", type: "number" },
      { name: "fecha", type: "date" },
      { name: "estado", type: "text" },
      { name: "notas", type: "text" },
      { name: "cliente_id", type: "text" },
      { name: "descuento", type: "number" },
      { name: "impuesto", type: "number" },
      { name: "metodo_pago", type: "text" },
      { name: "venta_id", type: "text" },
      { name: "fecha_pago", type: "date" },
      { name: "cliente_email", type: "text" },
      { name: "cliente_telefono", type: "text" },
      { name: "cliente_ruc", type: "text" },
      { name: "cliente_direccion", type: "text" },
      { name: "empresa_nombre", type: "text" },
      { name: "empresa_ruc", type: "text" },
      { name: "empresa_email", type: "text" },
      { name: "empresa_telefono", type: "text" },
      { name: "empresa_direccion", type: "text" },
      { name: "empresa_logo_url", type: "text" },
      { name: "productos_json", type: "json" },
      { name: "ventas_ids", type: "json" },
      { name: "codigos_venta_json", type: "text" },
    ],
  },
  {
    name: "historialMeses",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "mes", type: "text" },
      { name: "total_ventas", type: "number" },
      { name: "total_descuentos", type: "number" },
      { name: "total_final", type: "number" },
      { name: "total_egresos", type: "number" },
      { name: "egresos", type: "number" },
      { name: "gastos_fijos", type: "number" },
      { name: "deuda_anterior", type: "number" },
      { name: "deuda_pendiente", type: "number" },
      { name: "ganancia_neta", type: "number" },
      { name: "cantidad_transacciones", type: "number" },
      { name: "balance_final", type: "number" },
      { name: "ingresos", type: "number" },
      { name: "is_closed", type: "bool" },
    ],
  },
  {
    name: "inventario",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "nombre", type: "text", required: true },
      { name: "cantidad", type: "number" },
      { name: "precio", type: "number", required: true },
      { name: "descripcion", type: "text" },
      { name: "categoria", type: "text" },
      { name: "stock_minimo", type: "number" },
      { name: "fecha_agregado", type: "date" },
    ],
  },
  {
    name: "invoices",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "order_id", type: "text" },
      { name: "customer_id", type: "text", required: true },
      { name: "invoice_number", type: "text", required: true },
      { name: "invoice_date", type: "date" },
      { name: "due_date", type: "date" },
      { name: "status", type: "text" },
      { name: "subtotal", type: "number" },
      { name: "tax", type: "number" },
      { name: "discount", type: "number" },
      { name: "total", type: "number" },
      { name: "paid_amount", type: "number" },
      { name: "payment_method", type: "text" },
      { name: "notes", type: "text" },
    ],
  },
  {
    name: "notas_entrega",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "numero_nota", type: "text", required: true },
      { name: "cliente", type: "text", required: true },
      { name: "items", type: "json" },
      { name: "observaciones", type: "text" },
      { name: "fecha_entrega", type: "date" },
      { name: "estado", type: "text" },
      { name: "empresa_nombre", type: "text" },
      { name: "empresa_ruc", type: "text" },
      { name: "empresa_email", type: "text" },
      { name: "empresa_telefono", type: "text" },
      { name: "empresa_direccion", type: "text" },
      { name: "empresa_logo_url", type: "text" },
    ],
  },
  {
    name: "order_items",
    fields: [
      { name: "order_id", type: "text", required: true },
      { name: "product_id", type: "text", required: true },
      { name: "quantity", type: "number" },
      { name: "unit_price", type: "number" },
      { name: "discount_percentage", type: "number" },
      { name: "line_total", type: "number" },
      { name: "notes", type: "text" },
    ],
  },
  {
    name: "orders",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "customer_id", type: "text", required: true },
      { name: "code", type: "text", required: true },
      { name: "status", type: "text" },
      { name: "order_date", type: "date" },
      { name: "delivery_date", type: "date" },
      { name: "subtotal", type: "number" },
      { name: "tax", type: "number" },
      { name: "discount", type: "number" },
      { name: "total", type: "number" },
      { name: "payment_method", type: "text" },
      { name: "payment_status", type: "text" },
      { name: "notes", type: "text" },
    ],
  },
  {
    name: "pedidos",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "numero_pedido", type: "text" },
      { name: "cliente", type: "text" },
      { name: "items", type: "json" },
      { name: "total", type: "number" },
      { name: "estado", type: "text" },
      { name: "fecha_entrega_estimada", type: "date" },
      { name: "observaciones", type: "text" },
    ],
  },
  {
    name: "perfil_empresa",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "nombre_negocio", type: "text" },
      { name: "razon_social", type: "text" },
      { name: "nit", type: "text" },
      { name: "email", type: "text" },
      { name: "telefono", type: "text" },
      { name: "ciudad", type: "text" },
      { name: "departamento", type: "text" },
      { name: "direccion", type: "text" },
      { name: "logo_url", type: "text" },
      { name: "descripcion", type: "text" },
    ],
  },
  {
    name: "premium_subscriptions",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "status", type: "text" },
      { name: "payment_method", type: "text" },
      { name: "transaction_id", type: "text" },
      { name: "price", type: "number" },
      { name: "billing_cycle_anchor", type: "date" },
      { name: "current_period_start", type: "date" },
      { name: "current_period_end", type: "date" },
    ],
  },
  {
    name: "presupuestos",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "numero_presupuesto", type: "text", required: true },
      { name: "cliente", type: "text", required: true },
      { name: "items", type: "json" },
      { name: "subtotal", type: "number" },
      { name: "descuento", type: "number" },
      { name: "impuestos", type: "number" },
      { name: "total", type: "number" },
      { name: "fecha_creacion", type: "date" },
      { name: "fecha_vencimiento", type: "date" },
      { name: "estado", type: "text" },
      { name: "notas", type: "text" },
    ],
  },
  {
    name: "products",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "code", type: "text", required: true },
      { name: "name", type: "text", required: true },
      { name: "description", type: "text" },
      { name: "price", type: "number" },
      { name: "cost", type: "number" },
      { name: "quantity", type: "number" },
      { name: "category", type: "text" },
      { name: "image_url", type: "text" },
      { name: "sku", type: "text" },
      { name: "barcode", type: "text" },
      { name: "is_active", type: "bool" },
    ],
  },
  {
    name: "returns",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "order_id", type: "text" },
      { name: "product_id", type: "text" },
      { name: "reason", type: "text" },
      { name: "quantity_returned", type: "number" },
      { name: "refund_amount", type: "number" },
      { name: "status", type: "text" },
      { name: "replacement_product_id", type: "text" },
      { name: "notes", type: "text" },
    ],
  },
  {
    name: "settings",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "gastosFijos", type: "number" },
      { name: "isPremium", type: "text" },
    ],
  },
  {
    name: "sync_log",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "table_name", type: "text", required: true },
      { name: "action", type: "text" },
      { name: "record_id", type: "text" },
      { name: "synced", type: "bool" },
      { name: "error", type: "text" },
    ],
  },
  {
    name: "user_statistics",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "total_products", type: "number" },
      { name: "total_customers", type: "number" },
      { name: "total_orders", type: "number" },
      { name: "total_invoices", type: "number" },
      { name: "total_sales", type: "number" },
      { name: "completed_sales", type: "number" },
    ],
  },
  {
    name: "ventas",
    fields: [
      { name: "user_id", type: "text", required: true },
      { name: "codigo_venta", type: "text", required: true },
      { name: "cliente", type: "text", required: true },
      { name: "producto", type: "text", required: true },
      { name: "cantidad", type: "number" },
      { name: "monto", type: "number", required: true },
      { name: "descuento", type: "number" },
      { name: "total", type: "number" },
      { name: "metodo_pago", type: "text" },
      { name: "fecha", type: "date" },
      { name: "mes_cierre", type: "date" },
      { name: "notas", type: "text" },
      { name: "cliente_id", type: "text" },
      { name: "productos_json", type: "json" },
      { name: "facturado", type: "bool" },
      { name: "cantidad_productos", type: "number" },
    ],
  },
];

async function createCollections() {
  try {
    await pb.collection("_superusers").authWithPassword("mantenteapp@gmail.com", "31671702");
    console.log("✅ Autenticado");

    const existing = await pb.collections.getFullList();
    const existingNames = existing.map((c) => c.name);

    for (const collDef of collections) {
      if (existingNames.includes(collDef.name)) {
        console.log(`ℹ️  ${collDef.name} ya existe`);
        continue;
      }

      await pb.collections.create({
        name: collDef.name,
        type: collDef.type || "base",
        fields: collDef.fields,
      });
      console.log(`✅ Creada: ${collDef.name} (${collDef.type || "base"})`);
    }

    console.log("\n✅ ¡Todas las colecciones sincronizadas!");
  } catch (error) {
    console.error("❌ Error:", error.message);
    process.exit(1);
  }
}

createCollections();
